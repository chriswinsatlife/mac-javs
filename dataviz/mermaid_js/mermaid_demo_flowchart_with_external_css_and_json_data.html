<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sketchy Charts</title>
    
    <!-- External CSS -->
    <link rel="stylesheet" href="chart_styles.css">
    
    <!-- External Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Architects+Daughter&display=swap" rel="stylesheet">

    <!-- External libraries -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <script src="https://unpkg.com/svg2roughjs/dist/svg2roughjs.umd.min.js"></script>
</head>
<body>
    <h1>üé® Sketchy Chart Generator</h1>
    
    <div class="instructions" style="display: none !important">:
        <h4>üìù Edit your chart data and styling below, then click "Generate Chart"</h4>
    </div>
    
    <div class="edit-section">
        <h4>Chart Data:</h4>
        <textarea id="dataEditor">{
  "title": "NETFLIX",
  "type": "flowchart LR",
  "chart": "A([\"Start\"])\nA --> B{\"Decision\"}\nB --> C[\"Option A\"]\nB --> D[\"Option B\"]"
}</textarea>
    </div>
    
    <div class="edit-section">
        <h4>Styling Config:</h4>
        <textarea id="stylingEditor">{
  "roughConfig": {
    "roughness": 1,
    "bowing": 2,
    "fillStyle": "hachure",
    "fillWeight": 2,
    "hachureAngle": 45,
    "hachureGap": 4,
    "stroke": "#333",
    "strokeWidth": 2
  },
  "fontFamily": "Architects Daughter",
  "backgroundColor": "transparent",
  "randomize": true,
  "seed": 12345,
  "pencilFilter": true
}</textarea>
    </div>
    
    <button onclick="generateChart()">üé® Generate Sketchy Chart</button>
    <button onclick="loadExamples()">üìã Load Examples</button>
    
    <div class="chart-section">
        <h3 style="display: none !important;">‚úèÔ∏è Your Sketchy Chart</h3>
        <div id="rough-container">
            <p style="color: #666;">Click "Generate Chart" to create your sketchy visualization!</p>
        </div>
    </div>

    <!-- Hidden container for Mermaid rendering -->
    <div id="chart-container" style="display: none;"></div>

    <script>
        function generateChart() {
            try {
                // Parse the JSON from textareas
                const data = JSON.parse(document.getElementById('dataEditor').value);
                const styling = JSON.parse(document.getElementById('stylingEditor').value);
                
                console.log('Generating chart with:', data, styling);
                
                // Generate Mermaid code
                let mermaidCode;
                
                // Handle different chart types
                if (data.type === 'pie') {
                    mermaidCode = `${data.type}\n    title ${data.title}`;
                    if (data.values) {
                        data.values.forEach(item => {
                            mermaidCode += `\n    "${item.label}" : ${item.value}`;
                        });
                    }
                } else if (data.type.includes('flowchart')) {
                    // For flowcharts, use the chart property directly with proper spacing
                    mermaidCode = `${data.type}\n${data.chart}`;
                } else {
                    // Default fallback
                    mermaidCode = `${data.type}\n${data.chart || ''}`;
                }
                
                // Debug: Log the generated mermaid code
                console.log('Generated Mermaid code:', mermaidCode);
                
                // Clear containers
                document.getElementById('chart-container').innerHTML = `<div class="mermaid">${mermaidCode}</div>`;
                document.getElementById('rough-container').innerHTML = '<p>Generating...</p>';
                
                // Initialize Mermaid
                mermaid.initialize({ 
                    startOnLoad: false,
                    flowchart: {
                        htmlLabels: false  // Force SVG text instead of foreignObject
                    }
                });
                mermaid.run().then(() => {
                    console.log('Mermaid rendered');
                    
                    // Debug what actually got created
                    setTimeout(() => {
                        const svgElement = document.querySelector('#chart-container svg');
                        const chartContainer = document.getElementById('chart-container');
                        
                        console.log('Chart container innerHTML:', chartContainer.innerHTML);
                        console.log('SVG element found:', svgElement);
                        
                        if (svgElement) {
                            console.log('SVG dimensions:', svgElement.getBoundingClientRect());
                            console.log('SVG content length:', svgElement.innerHTML.length);
                            console.log('Original viewBox:', svgElement.getAttribute('viewBox'));
                            console.log('Original style:', svgElement.getAttribute('style'));
                            
                            // Instead of scaling viewBox, wrap content in a transform
                            const mainG = svgElement.querySelector('g');
                            if (mainG) {
                                mainG.setAttribute('transform', 'scale(20)');
                                console.log('Applied scale(20) transform to main content');
                            }
                            
                            // Keep original tiny viewBox but make it bigger
                            svgElement.setAttribute('viewBox', '-160 -160 320 320');
                            

                            
                            // Debug: Check what text rendering method is used
                            console.log('Text elements:', svgElement.querySelectorAll('text').length);
                            console.log('Foreign objects:', svgElement.querySelectorAll('foreignObject').length);
                            console.log('Spans in labels:', svgElement.querySelectorAll('.label span').length);
                            
                            // Log first foreignObject to see dimensions
                            const firstFO = svgElement.querySelector('foreignObject');
                            if (firstFO) {
                                console.log('First foreignObject:', {
                                    width: firstFO.getAttribute('width'),
                                    height: firstFO.getAttribute('height'),
                                    x: firstFO.getAttribute('x'),
                                    y: firstFO.getAttribute('y'),
                                    innerHTML: firstFO.innerHTML.substring(0, 100) + '...'
                                });
                            }
                            
                            // Let CSS handle all sizing for responsiveness
                            svgElement.removeAttribute('width');
                            svgElement.removeAttribute('height');
                            svgElement.removeAttribute('style');
                            
                            // Clone the working SVG and put it in the rough container
                            const clonedSvg = svgElement.cloneNode(true);
                            console.log('Cloned SVG viewBox:', clonedSvg.getAttribute('viewBox'));
                            
                            // Clear the rough container and add the cloned SVG
                            document.getElementById('rough-container').innerHTML = '';
                            document.getElementById('rough-container').appendChild(clonedSvg);
                            
                            // Remove all inline styles to let CSS handle sizing
                            clonedSvg.removeAttribute('style');
                            
                            console.log('Fixed SVG sizing and copied successfully');
                            console.log('Final viewBox:', clonedSvg.getAttribute('viewBox'));
                            console.log('New dimensions:', clonedSvg.getBoundingClientRect());
                        } else {
                            console.error('No SVG found in chart container!');
                            document.getElementById('rough-container').innerHTML = '<p style="color: red;">No SVG generated by Mermaid</p>';
                        }
                    }, 1000);
                }).catch(err => {
                    console.error('Mermaid failed:', err);
                    document.getElementById('rough-container').innerHTML = '<p style="color: red;">Chart generation failed</p>';
                });
                
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('rough-container').innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
            }
        }
        
        function loadExamples() {
            // Flowchart example
            document.getElementById('dataEditor').value = `{
                "title": "Decision Process",
                "type": "flowchart TD",
                "values": [
                    "A[Start] --> B{Is it working?}",
                    "B -->|Yes| C[Great!]",
                    "B -->|No| D[Fix it]",
                    "D --> B"
                ]
                }`;
            
            document.getElementById('stylingEditor').value = `{
                "roughConfig": {
                    "roughness": 2,
                    "bowing": 3,
                    "fillStyle": "zigzag",
                    "fillWeight": 2,
                    "stroke": "#8B4513",
                    "strokeWidth": 2
                },
                "fontFamily": "Gaegu Bold",
                "backgroundColor": "transparent",
                "randomize": true,
                "seed": 42,
                "pencilFilter": true
                }`;
        }
        
        // Auto-generate on page load
        document.addEventListener('DOMContentLoaded', () => {
            generateChart();
        });
    </script>
</body>
</html>