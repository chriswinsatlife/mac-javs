---
type Props = {
  id: string;
  dataUrl: string;
  height?: number;
  maxLines?: number;
  cssHref?: string;
};

const { id, dataUrl, height = 320, maxLines = 4, cssHref = '/diagrams/gifting_playbook_flow/runtime.css' } = Astro.props;
const dialogId = `${id}__flow_dialog`;

if (!id) throw new Error('flow_diagram_client: id required');
if (!dataUrl || !dataUrl.startsWith('/')) {
  throw new Error(`flow_diagram_client: dataUrl must be site-root (got: ${dataUrl})`);
}
---

<div class="flow-embed" style={`--flow-min-h:${height}px`} data-flow-lines={maxLines}>
  <button class="flow-embed__fs" type="button" data-flow-fs={dialogId} aria-label="View diagram full screen">
    Full screen
  </button>
  <svg id={id} class="flow-embed__svg" aria-label="Flow diagram" />
  <dialog id={dialogId} class="flow-embed__dialog">
    <div class="flow-embed__dialog_bar">
      <div class="flow-embed__dialog_title">Diagram</div>
      <form method="dialog">
        <button class="flow-embed__dialog_close" aria-label="Close full screen" type="submit">Close</button>
      </form>
    </div>
    <div class="flow-embed__dialog_stage" data-flow-stage></div>
  </dialog>
</div>

<script is:inline define:vars={{ id, dataUrl, dialogId, cssHref }}>
  (async () => {

    function loadScript(src) {
      return new Promise((resolve, reject) => {
        const s = document.createElement('script');
        s.src = src;
        s.async = true;
        s.onload = () => resolve();
        s.onerror = () => reject(new Error('Failed to load ' + src));
        document.head.appendChild(s);
      });
    }

    if (!window.d3) await loadScript('https://d3js.org/d3.v7.min.js');
    if (!window.dagre) await loadScript('https://cdn.jsdelivr.net/npm/@dagrejs/dagre@1.1.5/dist/dagre.min.js');
    if (!window.renderFlowDiagram) await loadScript('/diagrams/gifting_playbook_flow/flow_runtime.js');

    if (!document.querySelector(`link[data-flow-runtime="${cssHref}"]`)) {
      const link = document.createElement('link');
      link.rel = 'stylesheet';
      link.href = cssHref;
      link.dataset.flowRuntime = cssHref;
      document.head.appendChild(link);
    }

    const svg = document.getElementById(id);
    await window.renderFlowDiagram(svg, dataUrl);

    // Optional full-viewport view: still inline SVG (clone), no zoom/pan.
    const btn = document.querySelector(`[data-flow-fs="${dialogId}"]`);
    const dialog = document.getElementById(dialogId);
    const stage = dialog?.querySelector('[data-flow-stage]');
    if (btn && dialog && stage && dialog.showModal) {
      btn.addEventListener('click', () => {
        stage.innerHTML = '';
        const clone = svg.cloneNode(true);
        clone.removeAttribute('id');
        clone.style.width = '100%';
        clone.style.height = '100%';
        stage.appendChild(clone);
        dialog.showModal();
      });
      dialog.addEventListener('close', () => {
        stage.innerHTML = '';
      });
    }
  })().catch((err) => {
    console.error(err);
  });
</script>

<style>
  .flow-embed{
    min-height: var(--flow-min-h);
    border-radius: 16px;
    border: 1px solid rgba(0,0,0,0.06);
    background: rgba(5,36,12,0.03);
    overflow: hidden;
    position: relative;
  }

  .flow-embed__svg{
    width: 100%;
    height: 100%;
    display: block;
  }

  .flow-embed__fs{
    position: absolute;
    top: 10px;
    right: 10px;
    z-index: 2;
    font-size: 12px;
    font-weight: 650;
    letter-spacing: -0.01em;
    color: rgba(0,0,0,0.62);
    background: rgba(255,255,255,0.84);
    border: 1px solid rgba(0,0,0,0.10);
    border-radius: 999px;
    padding: 6px 10px;
    cursor: pointer;
    backdrop-filter: blur(8px);
  }
  .flow-embed__fs:hover{ background: rgba(255,255,255,0.94); color: rgba(0,0,0,0.74); }

  .flow-embed__dialog{
    width: 100vw;
    height: 100vh;
    max-width: none;
    max-height: none;
    padding: 0;
    border: none;
    background: rgba(255,255,255,0.98);
  }
  .flow-embed__dialog::backdrop{ background: rgba(0,0,0,0.45); }

  .flow-embed__dialog_bar{
    position: sticky;
    top: 0;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    padding: 14px 16px;
    border-bottom: 1px solid rgba(0,0,0,0.08);
    background: rgba(255,255,255,0.96);
    backdrop-filter: blur(10px);
  }
  .flow-embed__dialog_title{
    font-size: 13px;
    font-weight: 700;
    color: rgba(0,0,0,0.66);
  }
  .flow-embed__dialog_close{
    font-size: 12px;
    font-weight: 700;
    color: rgba(0,0,0,0.66);
    background: rgba(0,0,0,0.04);
    border: 1px solid rgba(0,0,0,0.10);
    border-radius: 999px;
    padding: 6px 10px;
    cursor: pointer;
  }
  .flow-embed__dialog_close:hover{ background: rgba(0,0,0,0.06); }

  .flow-embed__dialog_stage{
    height: calc(100vh - 54px);
    padding: 18px;
    overflow: hidden;
  }
  .flow-embed__dialog_stage > svg{
    width: 100%;
    height: 100%;
    display: block;
  }
</style>
